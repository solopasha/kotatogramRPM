From c9c3dcf891343c2eb415936c483ac390a94c6fa2 Mon Sep 17 00:00:00 2001
From: Your Name <you@example.com>
Date: Mon, 20 Sep 2021 04:01:12 -0700
Subject: [PATCH] TD 3.1

---
 Telegram/Resources/langs/rewrites/en.json     |  1 +
 Telegram/Resources/langs/rewrites/ru.json     |  1 +
 .../history/history_item_components.cpp       |  7 +++--
 .../SourceFiles/history/history_message.cpp   | 26 +++++++++++++----
 .../SourceFiles/history/history_widget.cpp    | 29 +++++++++++++++++++
 .../history/view/history_view_element.cpp     |  7 +++++
 Telegram/SourceFiles/kotato/json_settings.cpp |  5 ++++
 Telegram/SourceFiles/kotato/settings.cpp      | 11 +++++++
 Telegram/SourceFiles/kotato/settings.h        |  4 +++
 Telegram/SourceFiles/kotato/settings_menu.cpp |  1 +
 10 files changed, 84 insertions(+), 8 deletions(-)

diff --git a/Telegram/Resources/langs/rewrites/en.json b/Telegram/Resources/langs/rewrites/en.json
index 95916a2fd..4ea107c78 100644
--- a/Telegram/Resources/langs/rewrites/en.json
+++ b/Telegram/Resources/langs/rewrites/en.json
@@ -168,6 +168,7 @@
 	"ktg_admin_log_banned_send_games": "Send games",
 	"ktg_admin_log_banned_use_inline": "Use inline bots",
 	"ktg_forward_go_to_chat": "Go to chat",
+	"ktg_settings_block_users_in_groups": "Block users in groups",
 	"ktg_settings_forward": "Forward",
 	"ktg_settings_forward_retain_selection": "Retain selection after forward",
 	"ktg_settings_forward_chat_on_click": "Open chat on click",
diff --git a/Telegram/Resources/langs/rewrites/ru.json b/Telegram/Resources/langs/rewrites/ru.json
index f42cd1b40..7c54812a0 100644
--- a/Telegram/Resources/langs/rewrites/ru.json
+++ b/Telegram/Resources/langs/rewrites/ru.json
@@ -186,6 +186,7 @@
 	"ktg_admin_log_banned_send_games": "Отправка игр",
 	"ktg_admin_log_banned_use_inline": "Отправка через ботов",
 	"ktg_forward_go_to_chat": "Перейти в чат",
+	"ktg_settings_block_users_in_groups": "Блокировать пользователей в группах",
 	"ktg_settings_forward": "Пересылка",
 	"ktg_settings_forward_retain_selection": "Сохранять выделение после пересылки",
 	"ktg_settings_forward_chat_on_click": "Открывать чат по клику",
diff --git a/Telegram/SourceFiles/history/history_item_components.cpp b/Telegram/SourceFiles/history/history_item_components.cpp
index 563cc4bcf..6535a7ba9 100644
--- a/Telegram/SourceFiles/history/history_item_components.cpp
+++ b/Telegram/SourceFiles/history/history_item_components.cpp
@@ -355,7 +355,10 @@ void HistoryMessageReply::paint(
 	p.fillRect(rbar, bar);
 
 	if (w > st::msgReplyBarSkip) {
-		if (replyToMsg) {
+		auto blocked = replyToMsg
+			&& replyToMsg->from()->isUser()
+			&& replyToMsg->from()->asUser()->isBlocked();
+		if (replyToMsg && (!blocked || !BlockUsersInGroups())) {
 			auto hasPreview = replyToMsg->media() ? replyToMsg->media()->hasReplyPreview() : false;
 			if (hasPreview && w < st::msgReplyBarSkip + st::msgReplyBarSize.height()) {
 				hasPreview = false;
@@ -402,7 +405,7 @@ void HistoryMessageReply::paint(
 			p.setPen(inBubble
 				? stm->msgDateFg
 				: st->msgDateImgFg());
-			p.drawTextLeft(x + st::msgReplyBarSkip, y + st::msgReplyPadding.top() + (st::msgReplyBarSize.height() - st::msgDateFont->height) / 2, w + 2 * x, st::msgDateFont->elided(replyToMsgId ? tr::lng_profile_loading(tr::now) : tr::lng_deleted_message(tr::now), w - st::msgReplyBarSkip));
+			p.drawTextLeft(x + st::msgReplyBarSkip, y + st::msgReplyPadding.top() + (st::msgReplyBarSize.height() - st::msgDateFont->height) / 2, w + 2 * x, st::msgDateFont->elided((replyToMsgId && (!blocked || !BlockUsersInGroups())) ? tr::lng_profile_loading(tr::now) : tr::lng_deleted_message(tr::now), w - st::msgReplyBarSkip));
 		}
 	}
 }
diff --git a/Telegram/SourceFiles/history/history_message.cpp b/Telegram/SourceFiles/history/history_message.cpp
index 799e2770e..0978c608c 100644
--- a/Telegram/SourceFiles/history/history_message.cpp
+++ b/Telegram/SourceFiles/history/history_message.cpp
@@ -495,16 +495,30 @@ HistoryMessage::HistoryMessage(
 
 	createComponents(config);
 
-	if (const auto media = data.vmedia()) {
-		setMedia(*media);
+	UserId from = peerToUser(data.vfrom_id() ? peerFromMTP(*data.vfrom_id()) : PeerId(0));
+	PeerData* pd = from ? history->owner().user(from) : history->peer;
+	if (pd->isUser() && pd->asUser()->isBlocked() && BlockUsersInGroups()) {
+		const auto textWithEntities = TextWithEntities {
+		TextUtilities::Clean(qs("The message from blocked user")),
+		Api::EntitiesFromMTP(
+			&history->session(),
+			data.ventities().value_or_empty())
+		};
+		setText(_media ? textWithEntities : EnsureNonEmpty(textWithEntities));
 	}
-	const auto textWithEntities = TextWithEntities{
+	else {
+		if (const auto media = data.vmedia()) {
+			setMedia(*media);
+		}
+		const auto textWithEntities = TextWithEntities {
 		TextUtilities::Clean(qs(data.vmessage())),
-		Api::EntitiesFromMTP(
+		Api::EntitiesFromMTP (
 			&history->session(),
 			data.ventities().value_or_empty())
-	};
-	setText(_media ? textWithEntities : EnsureNonEmpty(textWithEntities));
+		};
+		setText(_media ? textWithEntities : EnsureNonEmpty(textWithEntities));
+	}
+
 	if (const auto groupedId = data.vgrouped_id()) {
 		setGroupId(
 			MessageGroupId::FromRaw(history->peer->id, groupedId->v));
diff --git a/Telegram/SourceFiles/history/history_widget.cpp b/Telegram/SourceFiles/history/history_widget.cpp
index 3afe0e8cb..8c5f74508 100644
--- a/Telegram/SourceFiles/history/history_widget.cpp
+++ b/Telegram/SourceFiles/history/history_widget.cpp
@@ -13,6 +13,7 @@ https://github.com/telegramdesktop/tdesktop/blob/master/LEGAL
 #include "api/api_sending.h"
 #include "api/api_text_entities.h"
 #include "api/api_send_progress.h"
+#include "api/api_blocked_peers.h"
 #include "boxes/confirm_box.h"
 #include "boxes/send_files_box.h"
 #include "boxes/share_box.h"
@@ -640,6 +641,34 @@ HistoryWidget::HistoryWidget(
 		});
 	}, lifetime());
 
+	BlockUsersInGroupsChanges(
+	) | rpl::start_with_next([=] {
+		crl::on_main(this, [=] {
+			if (_history) {
+				_history->forceFullResize();
+				if (_migrated) {
+					_migrated->forceFullResize();
+				}
+				updateHistoryGeometry();
+				update();
+			}
+		});
+	}, lifetime());
+
+	session().api().blockedPeers().slice(
+	) | rpl::start_with_next([=] {
+		crl::on_main(this, [=] {
+			if (_history) {
+				_history->forceFullResize();
+				if (_migrated) {
+					_migrated->forceFullResize();
+				}
+				updateHistoryGeometry();
+				update();
+			}
+		});
+	}, lifetime());
+
 	HoverEmojiPanelChanges(
 	) | rpl::start_with_next([=] {
 		crl::on_main(this, [=] {
diff --git a/Telegram/SourceFiles/history/view/history_view_element.cpp b/Telegram/SourceFiles/history/view/history_view_element.cpp
index e588bdb92..ee8133474 100644
--- a/Telegram/SourceFiles/history/view/history_view_element.cpp
+++ b/Telegram/SourceFiles/history/view/history_view_element.cpp
@@ -28,6 +28,7 @@ https://github.com/telegramdesktop/tdesktop/blob/master/LEGAL
 #include "ui/toast/toast.h"
 #include "ui/toasts/common_toasts.h"
 #include "data/data_session.h"
+#include "data/data_user.h"
 #include "data/data_groups.h"
 #include "data/data_media_types.h"
 #include "lang/lang_keys.h"
@@ -477,6 +478,12 @@ bool Element::isHiddenByGroup() const {
 }
 
 bool Element::isHidden() const {
+	if (BlockUsersInGroups()
+		&& data()->from()->isUser()
+		&& data()->from()->asUser()->isBlocked()) {
+		return true;
+	}
+
 	return isHiddenByGroup();
 }
 
diff --git a/Telegram/SourceFiles/kotato/json_settings.cpp b/Telegram/SourceFiles/kotato/json_settings.cpp
index 300721b38..b44cd926b 100644
--- a/Telegram/SourceFiles/kotato/json_settings.cpp
+++ b/Telegram/SourceFiles/kotato/json_settings.cpp
@@ -366,6 +366,7 @@ QByteArray GenerateSettingsJson(bool areDefault = false) {
 	settings.insert(qsl("sticker_scale_both"), StickerScaleBoth());
 	settings.insert(qsl("adaptive_bubbles"), AdaptiveBubbles());
 	settings.insert(qsl("big_emoji_outline"), BigEmojiOutline());
+	settings.insert(qsl("block_users_in_groups"), BlockUsersInGroups());
 	settings.insert(qsl("always_show_scheduled"), cAlwaysShowScheduled());
 	settings.insert(qsl("show_chat_id"), ShowChatId());
 	settings.insert(qsl("show_phone_in_drawer"), cShowPhoneInDrawer());
@@ -525,6 +526,10 @@ bool Manager::readCustomFile() {
 		SetBigEmojiOutline(v);
 	});
 
+	ReadBoolOption(settings, "block_users_in_groups", [&](auto v) {
+		SetBlockUsersInGroups(v);
+	});
+
 	ReadBoolOption(settings, "always_show_scheduled", [&](auto v) {
 		cSetAlwaysShowScheduled(v);
 	});
diff --git a/Telegram/SourceFiles/kotato/settings.cpp b/Telegram/SourceFiles/kotato/settings.cpp
index 524f7ca60..c94512b28 100644
--- a/Telegram/SourceFiles/kotato/settings.cpp
+++ b/Telegram/SourceFiles/kotato/settings.cpp
@@ -79,6 +79,17 @@ rpl::producer<bool> MonospaceLargeBubblesChanges() {
 	return gMonospaceLargeBubbles.changes();
 }
 
+rpl::variable<bool> gBlockUsersInGroups = false;
+void SetBlockUsersInGroups(bool enabled) {
+	gBlockUsersInGroups = enabled;
+}
+bool BlockUsersInGroups() {
+	return gBlockUsersInGroups.current();
+}
+rpl::producer<bool> BlockUsersInGroupsChanges() {
+	return gBlockUsersInGroups.changes();
+}
+
 bool gAlwaysShowScheduled = false;
 
 rpl::variable<int> gShowChatId = 2;
diff --git a/Telegram/SourceFiles/kotato/settings.h b/Telegram/SourceFiles/kotato/settings.h
index a3eca2017..f54fec547 100644
--- a/Telegram/SourceFiles/kotato/settings.h
+++ b/Telegram/SourceFiles/kotato/settings.h
@@ -62,6 +62,10 @@ void SetMonospaceLargeBubbles(bool enabled);
 [[nodiscard]] bool MonospaceLargeBubbles();
 [[nodiscard]] rpl::producer<bool> MonospaceLargeBubblesChanges();
 
+void SetBlockUsersInGroups(bool enabled);
+[[nodiscard]] bool BlockUsersInGroups();
+[[nodiscard]] rpl::producer<bool> BlockUsersInGroupsChanges();
+
 DeclareSetting(bool, AlwaysShowScheduled);
 
 void SetShowChatId(int chatIdType);
diff --git a/Telegram/SourceFiles/kotato/settings_menu.cpp b/Telegram/SourceFiles/kotato/settings_menu.cpp
index 21cf96920..53ad9bfe9 100644
--- a/Telegram/SourceFiles/kotato/settings_menu.cpp
+++ b/Telegram/SourceFiles/kotato/settings_menu.cpp
@@ -379,6 +379,7 @@ void SetupKotatoMessages(not_null<Ui::VerticalLayout*> container) {
 	}
 
 	SettingsMenuSwitch(ktg_settings_emoji_outline, BigEmojiOutline);
+	SettingsMenuSwitch(ktg_settings_block_users_in_groups, BlockUsersInGroups);
 
 	AddSkip(container);
 }
-- 
2.33.0.windows.2

